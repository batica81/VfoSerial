<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VFO Serial</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
    <script src="/socket.io/socket.io.js"></script>
    <script src="Morse.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>
<body>

<div class="cwArea">CW</div>
<div class="setFrequencyWrapper">
    <input class="currentFrequencyInput" type="text" value="0" placeholder="0">
    <button class="setFrequencyButton">Set Frequency</button>
</div>


<form action="">
    <input id="m" autocomplete="off" /><button>Send</button>
</form>

<div class="sliderWrapper">
    <label for="freqSlider">Enter frequency</label>
    <!--<input type="range" value="0" min="8000" max="150000000" step="10" class="freqSlider" name="freqSlider" id="freqSlider">-->
    <input type="range" value="0" min="5145000" max="5165000" step="100" class="freqSlider" name="freqSlider" id="freqSlider">
</div>

<button class="stopButon">STOP</button>

<ul id="messages"></ul>

<script>
    $(function () {

        // create web audio api context
        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        var oscillator;

        let currentFrequency = 0;
        let setFrequencyButton = document.querySelector('.setFrequencyButton');
        let currentFrequencyInput = document.querySelector('.currentFrequencyInput');

        setFrequencyButton.addEventListener("click", function (){
            if (MorseJs.empty){
                morseInit();
            }
            currentFrequency = currentFrequencyInput.value;
            console.log(currentFrequency);
            // MorseJs.Play("cq cq de n5jlc k", 20, 500);
        })

        var socket = io();
        $('form').submit(function(e) {
            e.preventDefault(); // prevents page reloading
            socket.emit('chat message', $('#m').val());
            $('#m').val('');
            return false;
        });
        // socket.on('chat message', function(msg){
        //     $('#messages').append($('<li>').text(msg));
        // });

        $('.freqSlider').on("input", function () {
            socket.emit('chat message', this.value);
            // console.log(this.value);
        })

        $('.stopButon').on("click", function () {
            socket.emit('chat message', 0);
            console.log("STOP sent");
        })

        $('.cwArea').on("mousedown", function () {
            socket.emit('chat message', currentFrequency);

            // create Oscillator node
            if  (currentFrequency < 96000) {
                oscillator = audioCtx.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(currentFrequency, audioCtx.currentTime); // value in hertz
                oscillator.connect(audioCtx.destination);
                oscillator.start();
            } else {
                console.log('Sidetone only up to 96khz');
            }

        }).on("mouseup", function () {
            socket.emit('chat message', 0);
            // console.log("RELEASED");
            if (oscillator){
                oscillator.stop();
            }

        })






    })

</script>
</body>
</html>
